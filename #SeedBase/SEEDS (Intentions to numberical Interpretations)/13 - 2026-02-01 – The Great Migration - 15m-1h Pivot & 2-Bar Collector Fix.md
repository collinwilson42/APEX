# Structure – Seed Log

---

13: 2026-02-01 – The Great Migration: 15m/1h Pivot & 2-Bar Collector Fix ^seed-structure-migration

## Prompts & Execution
"Abandon the 1m chart completely and switch to 1hr and 15m... we will collect it correctly this time using the 2 bar collector idea to fix the candle gaps... full import of new data."

## 1. Seed (Intent)
- **Objective:** Pivot the entire system's heartbeat from `1m/15m` to `15m/1h` and implement the "2-Bar Snapshot" fix to eliminate data gaps.
- **Specifics:**
    - **Timeframe Shift:** Purge `1m` logic. Configure `init2.py` and `collector` to fetch `15m` (Tactical) and `1h` (Trend).
    - **The "Gap Fix":** Update `mt5_collector` to always fetch `count=2` (Current + Previous) bars. This ensures the "Closed" bar gets a final update to lock in the true Close price.
    - **Backfill:** Trigger a massive backfill for `1h` data (50k bars) on startup.
    - **Profile Update:** Update `maestro_v2.json` to weight `1h` heavily and ignore `1m`.

## 2. Related (Context)
- `init2.py` (The Loop).
- `mt5_collector_v11_3.py` (The Collector).
- `profiles/maestro_v2.json` (The Config).

## 4. Foundation (Structure)
*Files to be modified:*
- `init2.py`:
    - **Config:** Change `ACTIVE_TIMEFRAMES` from `['1m', '15m']` to `['15m', '1h']`.
    - **Backfill:** Ensure `full_backfill_timeframe` handles `mt5.TIMEFRAME_H1`.
- `mt5_collector_v11_3.py`:
    - **Logic Change:** Update `copy_rates_from_pos(..., count=1)` to `count=2`.
    - **Loop:** Iterate through *both* returned bars and `INSERT OR REPLACE` to seal the previous bar.
- `sentiment_engine.py`:
    - Update logic to analyze `1h` charts instead of `1m`.
- `profiles/maestro_v2.json`:
    - Update weights: `"timeframe_weights": {"1m": 0.0, "15m": 0.4, "1h": 0.6}`.

## 8. Infinity (Patterns)
- **Pattern:** **The "Double-Tap" Write.** Writing the *Previous* bar ensures accuracy (Close Price). Writing the *Current* bar ensures responsiveness (Live Price).
- **Anti-Pattern:** **Tick Noise.** Abandoning the 1m chart removes 80% of the false signals generated by "micro-structure" noise.

## 5. Senses (UX/DX)
- **Visuals:** The UI charts will now look "Smooth" (connected candles) because the Close of Bar A will perfectly match the Open of Bar B.
- **Pacing:** The system will feel less "frantic."

## 7. Evolution (Real-Time Log)
*Claude: Log milestones here.*
- [x] [Updated `mt5_collector` to fetch 2 bars (Gap Fix) - **DONE**]
- [x] [Refactored `init2.py` to collect 15m & 1h - **DONE**]
- [x] [Updated `config.py` COLLECTOR_TIMEFRAMES to ['15m', '1h'] - **DONE**]
- [x] [Updated `sentiment_engine.py` to use 1h instead of 1m - **DONE**]
- [x] [Updated Frontend JS: apex_views.js, apex_indicators.js (1m→1h) - **DONE**]
- [x] [Created `clear_for_migration.py` script to purge databases - **DONE**]
- [ ] [Executed Full Backfill for 1h data (50k bars) - **Pending: Run clear_for_migration.py then init2.py**]
- [ ] [Updated `maestro_v2.json` weights - **No profile file found, skipped**]

## Architecture Flow (The 2-Bar Fix)
```mermaid
graph TD
    Loop[Collector Loop] -->|Fetch Count=2| MT5[MetaTrader 5]
    MT5 -->|Return Array| Rates[[Bar_Prev, Bar_Curr]]
    
    subgraph Database_Update
        Rates -->|Index 0: CLOSED| DB_Seal[Update Previous Bar (Final Close)]
        Rates -->|Index 1: OPEN| DB_Live[Update Current Bar (Live Price)]
    end
    
    DB_Seal -->|Result| Seamless[No Gaps on Chart]

    Based on the behavior you are describing—where the Close of Candle A does not align with the Open of Candle B—the issue is almost certainly a "Snapshot Timing Error" in your mt5_collector_v11_3.py.

The Discrepancy Explained
In a live loop, the collector captures the "Current Price" and saves it as the "Close" of the active candle.

Scenario: Your loop runs at 10:00:05. It captures the 10:00 candle. The "Close" is the price at 10:00:05.

The Problem: If the loop sleeps for 60 seconds (or is busy), it wakes up at 10:01:05. It creates the new 10:01 candle.

The Gap: You never went back to update the 10:00 candle with the actual closing price at 10:00:59. The database effectively froze the 10:00 candle at 10:00:05. The price moved significantly between 10:00:05 and 10:01:00, creating a visual step/gap on the chart.

The Fix: "The 2-Bar Rule"
You must modify mt5_collector_v11_3.py to always fetch and update the Last 2 Bars, not just the current one. This ensures that when a new bar starts, you perform one final "Seal" on the previous bar to lock in the correct Close price.

1. Locate the Fetch Logic in mt5_collector_v11_3.py Find the line where mt5.copy_rates_from_pos is called inside the main loop. It likely looks like this:

Python
# CURRENT (Likely Cause of Error)
rates = mt5.copy_rates_from_pos(symbol, timeframe, 0, 1) 
# Fetches only the current forming bar (Index 0)
2. Update to Fetch 2 Bars Change the count to 2 to grab the current bar AND the previously closed bar.

Python
# CORRECTED LOGIC
rates = mt5.copy_rates_from_pos(symbol, timeframe, 0, 2)
# rates[0] = The Previous Bar (Closed) - We need to update this one last time!
# rates[1] = The Current Bar (Active)
3. Loop Through Both and Upsert Update your loop to iterate through these rates and perform the INSERT OR REPLACE.

Python
# Inside your collector loop
rates = mt5.copy_rates_from_pos(symbol, timeframe, 0, 2)

if rates is not None:
    for rate in rates:
        # This ensures the 'Closed' bar gets its final price, 
        # AND the 'Active' bar gets its live price.
        insert_bar_to_db(rate) 
Summary of Changes
Change count=1 to count=2 in your copy_rates call.

Ensure your INSERT SQL statement uses INSERT OR REPLACE (which it appears to do in init2.py, just verify mt5_collector_v11_3.py does the same).

This will force the "Previous Candle" to snap to its true closing price every time the loop runs, eliminating the gaps.