<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIZAUDE - Markov Matrix Control Panel</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 15px;
        }
        
        .container {
            max-width: 1900px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(184, 134, 11, 0.2), rgba(0,0,0,0.3));
            border: 1px solid rgba(184, 134, 11, 0.4);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 28px;
            color: #ffd700;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }
        
        .header-left .subtitle {
            color: rgba(255, 215, 0, 0.7);
            font-size: 12px;
            letter-spacing: 2px;
        }
        
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .control-btn {
            padding: 12px 25px;
            border: 1px solid rgba(184, 134, 11, 0.5);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .btn-start {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.3), rgba(78, 205, 196, 0.1));
            color: #4ecdc4;
        }
        
        .btn-start:hover {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.5), rgba(78, 205, 196, 0.2));
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.4);
        }
        
        .btn-start.active {
            background: linear-gradient(135deg, #4ecdc4, #45b7aa);
            color: #0a0a0a;
            animation: pulse-green 2s infinite;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 107, 107, 0.1));
            color: #ff6b6b;
        }
        
        .btn-stop:hover {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.5), rgba(255, 107, 107, 0.2));
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.4);
        }
        
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 10px rgba(78, 205, 196, 0.4); }
            50% { box-shadow: 0 0 25px rgba(78, 205, 196, 0.8); }
        }
        
        /* Grid Layouts */
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .grid-2-1 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        /* Panels */
        .panel {
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.95), rgba(10, 10, 15, 0.98));
            border: 1px solid rgba(184, 134, 11, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .panel-header {
            background: linear-gradient(90deg, rgba(184, 134, 11, 0.3), transparent);
            padding: 12px 15px;
            border-bottom: 1px solid rgba(184, 134, 11, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-header h3 {
            color: #ffd700;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .panel-header .badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }
        
        .panel-body {
            padding: 15px;
        }
        
        .panel-body.no-padding {
            padding: 0;
        }
        
        /* Current Regime Display - Compact */
        .regime-display {
            text-align: center;
            padding: 15px;
        }
        
        .regime-name {
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .regime-bullish { color: #4ecdc4; text-shadow: 0 0 15px rgba(78, 205, 196, 0.5); }
        .regime-bearish { color: #ff6b6b; text-shadow: 0 0 15px rgba(255, 107, 107, 0.5); }
        .regime-ranging { color: #ffd700; text-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .regime-volatile { color: #ff9f43; text-shadow: 0 0 15px rgba(255, 159, 67, 0.5); }
        .regime-breakout { color: #a29bfe; text-shadow: 0 0 15px rgba(162, 155, 254, 0.5); }
        .regime-reversal { color: #fd79a8; text-shadow: 0 0 15px rgba(253, 121, 168, 0.5); }
        
        .regime-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 12px;
            font-size: 11px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            color: rgba(255, 215, 0, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 9px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #4ecdc4;
            margin-top: 3px;
        }
        
        /* Signal Display - Compact */
        .signal-display {
            text-align: center;
            padding: 15px;
        }
        
        .signal-badge {
            display: inline-block;
            padding: 10px 30px;
            border-radius: 6px;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
        }
        
        .signal-buy { background: rgba(78, 205, 196, 0.2); border: 2px solid #4ecdc4; color: #4ecdc4; }
        .signal-sell { background: rgba(255, 107, 107, 0.2); border: 2px solid #ff6b6b; color: #ff6b6b; }
        .signal-hold { background: rgba(255, 215, 0, 0.2); border: 2px solid #ffd700; color: #ffd700; }
        
        .confidence-bar {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .confidence-fill.high { background: linear-gradient(90deg, #4ecdc4, #45b7aa); }
        .confidence-fill.medium { background: linear-gradient(90deg, #ffd700, #f0c000); }
        .confidence-fill.low { background: linear-gradient(90deg, #ff6b6b, #ff5252); }
        
        /* STOIC Grid - Compact */
        .stoic-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        .stoic-item {
            text-align: center;
            padding: 10px 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }
        
        .stoic-letter {
            font-size: 20px;
            font-weight: 700;
        }
        
        .stoic-pass { color: #4ecdc4; }
        .stoic-fail { color: #ff6b6b; }
        
        .stoic-label {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 3px;
        }
        
        /* Markov Matrix - Compact */
        .markov-matrix {
            width: 100%;
            border-collapse: separate;
            border-spacing: 2px;
            font-size: 10px;
        }
        
        .markov-matrix th,
        .markov-matrix td {
            padding: 8px 5px;
            text-align: center;
            border-radius: 3px;
        }
        
        .markov-matrix th {
            background: rgba(184, 134, 11, 0.3);
            color: #ffd700;
            font-weight: 600;
        }
        
        .markov-matrix td {
            background: rgba(0, 0, 0, 0.3);
            font-family: 'Consolas', monospace;
        }
        
        .markov-matrix td.highlight {
            background: rgba(78, 205, 196, 0.3);
            color: #4ecdc4;
            font-weight: 600;
        }
        
        .markov-matrix tr.current-row td {
            background: rgba(255, 215, 0, 0.15);
        }
        
        .prob-high { color: #4ecdc4; }
        .prob-medium { color: #ffd700; }
        .prob-low { color: rgba(255, 255, 255, 0.4); }
        
        /* Chart Container */
        .chart-container {
            width: 100%;
            height: 500px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        /* Vision Config */
        .vision-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .config-group {
            margin-bottom: 12px;
        }
        
        .config-label {
            font-size: 10px;
            color: rgba(255, 215, 0, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .config-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(184, 134, 11, 0.4);
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 12px;
        }
        
        .config-input:focus {
            outline: none;
            border-color: #ffd700;
        }
        
        .config-select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(184, 134, 11, 0.4);
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 12px;
        }
        
        .config-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 107, 107, 0.3);
            border-radius: 26px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #4ecdc4, #45b7aa);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* Regime Distribution Bars */
        .regime-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .regime-bar-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .regime-bar-label {
            width: 80px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
        }
        
        .regime-bar-track {
            flex: 1;
            height: 16px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .regime-bar-fill {
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 9px;
            font-weight: 600;
            color: #0a0a0a;
            transition: width 0.5s ease;
        }
        
        .bar-bullish { background: linear-gradient(90deg, #4ecdc4, #45b7aa); }
        .bar-bearish { background: linear-gradient(90deg, #ff6b6b, #ff5252); }
        .bar-ranging { background: linear-gradient(90deg, #ffd700, #f0c000); }
        .bar-volatile { background: linear-gradient(90deg, #ff9f43, #ee8c2c); }
        .bar-breakout { background: linear-gradient(90deg, #a29bfe, #8c82fc); }
        .bar-reversal { background: linear-gradient(90deg, #fd79a8, #e8679a); }
        
        /* Indicator Cards */
        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .indicator-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 10px;
            border-left: 3px solid #ffd700;
        }
        
        .indicator-card.positive { border-left-color: #4ecdc4; }
        .indicator-card.negative { border-left-color: #ff6b6b; }
        .indicator-card.neutral { border-left-color: #ffd700; }
        
        .indicator-name {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .indicator-value {
            font-size: 16px;
            font-weight: 600;
            margin-top: 3px;
        }
        
        .indicator-value.positive { color: #4ecdc4; }
        .indicator-value.negative { color: #ff6b6b; }
        .indicator-value.neutral { color: #ffd700; }
        
        /* Tabs */
        .tab-container {
            margin-bottom: 15px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            background: rgba(184, 134, 11, 0.1);
            border: 1px solid rgba(184, 134, 11, 0.3);
            color: rgba(255, 215, 0, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-radius: 4px;
        }
        
        .tab-btn:hover {
            background: rgba(184, 134, 11, 0.2);
            color: #ffd700;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, rgba(184, 134, 11, 0.3), rgba(255, 215, 0, 0.1));
            border-color: #ffd700;
            color: #ffd700;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(184, 134, 11, 0.5);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #ffd700;
        }
        
        /* Status Footer */
        .status-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(184, 134, 11, 0.2);
            font-size: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ecdc4;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-dot.offline { background: #ff6b6b; animation: none; }
        
        /* Navigation */
        .nav-links {
            display: flex;
            gap: 8px;
        }
        
        .nav-link {
            padding: 8px 15px;
            background: rgba(184, 134, 11, 0.2);
            border: 1px solid rgba(184, 134, 11, 0.4);
            border-radius: 6px;
            color: #ffd700;
            text-decoration: none;
            font-size: 10px;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: rgba(184, 134, 11, 0.3);
            border-color: #ffd700;
        }
        
        /* Score Display */
        .score-display {
            text-align: center;
            padding: 15px;
        }
        
        .score-value {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .score-label {
            font-size: 10px;
            color: rgba(255, 215, 0, 0.6);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 5px;
        }
        
        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 11px;
        }
        
        .data-table th {
            background: rgba(184, 134, 11, 0.2);
            color: #ffd700;
            padding: 10px;
            text-align: left;
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .data-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(184, 134, 11, 0.1);
        }
        
        .data-table tbody tr:hover {
            background: rgba(184, 134, 11, 0.1);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>WIZAUDE</h1>
                <div class="subtitle">MARKOV MATRIX • TRINITY CORE • APEX SIGNALS</div>
            </div>
            <div class="header-controls">
                <select id="timeframeSelect" class="config-select" style="width: 100px;">
                    <option value="15m" selected>15 MIN</option>
                    <option value="1m">1 MIN</option>
                </select>
                <button class="control-btn btn-start" id="btnStart" onclick="startLive()">▶ START</button>
                <button class="control-btn btn-stop" id="btnStop" onclick="stopLive()">■ STOP</button>
                <div class="nav-links">
                    <a href="/chart-data" class="nav-link">DATABASE</a>
                    <a href="/tunity" class="nav-link">TUNITY</a>
                </div>
            </div>
        </div>
        
        <!-- Row 1: Regime + Signal + Score + STOIC -->
        <div class="grid-4">
            <!-- Current Regime -->
            <div class="panel">
                <div class="panel-header">
                    <h3>Current Regime</h3>
                    <span class="badge" id="regimeTimestamp">--</span>
                </div>
                <div class="panel-body">
                    <div class="regime-display">
                        <div class="regime-name regime-ranging" id="regimeName">RANGING</div>
                        <div class="regime-stats">
                            <div class="stat-item">
                                <div class="stat-label">State</div>
                                <div class="stat-value" id="stateId">2</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Persist</div>
                                <div class="stat-value" id="persistence">0.75</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Cycles</div>
                                <div class="stat-value" id="cycles">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trinity Signal -->
            <div class="panel">
                <div class="panel-header">
                    <h3>Trinity Signal</h3>
                    <span class="badge" id="signalGate">Gate: --</span>
                </div>
                <div class="panel-body">
                    <div class="signal-display">
                        <div class="signal-badge signal-hold" id="signalBadge">HOLD</div>
                        <div style="margin-top: 8px; font-size: 11px;">
                            <span style="color: rgba(255,255,255,0.6);">Confidence:</span>
                            <span id="confidenceValue" style="color: #4ecdc4; font-weight: 600;">50%</span>
                            <span style="margin-left: 15px; color: rgba(255,255,255,0.6);">North Star:</span>
                            <span id="northStar" style="color: #ffd700; font-weight: 600;">1.000</span>
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-fill medium" id="confidenceFill" style="width: 50%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dynamic Score -->
            <div class="panel">
                <div class="panel-header">
                    <h3>Trade Score</h3>
                    <span class="badge" id="scoreGate">Gate --</span>
                </div>
                <div class="panel-body">
                    <div class="score-display">
                        <div class="score-value" id="tradeScore">0</div>
                        <div class="score-label">Weighted Score</div>
                        <div style="margin-top: 10px; font-size: 10px; color: rgba(255,255,255,0.5);">
                            <span>PF: <span id="profitFactor">1.00</span></span>
                            <span style="margin-left: 15px;">NP: <span id="netProfit">$0</span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STOIC Validation -->
            <div class="panel">
                <div class="panel-header">
                    <h3>STOIC Validation</h3>
                    <span class="badge" id="stoicStatus">--</span>
                </div>
                <div class="panel-body">
                    <div class="stoic-grid">
                        <div class="stoic-item">
                            <div class="stoic-letter stoic-pass" id="stoicS">S</div>
                            <div class="stoic-label">Stable</div>
                        </div>
                        <div class="stoic-item">
                            <div class="stoic-letter stoic-pass" id="stoicT">T</div>
                            <div class="stoic-label">Target</div>
                        </div>
                        <div class="stoic-item">
                            <div class="stoic-letter stoic-pass" id="stoicO">O</div>
                            <div class="stoic-label">Order</div>
                        </div>
                        <div class="stoic-item">
                            <div class="stoic-letter stoic-pass" id="stoicI">I</div>
                            <div class="stoic-label">Insight</div>
                        </div>
                        <div class="stoic-item">
                            <div class="stoic-letter stoic-pass" id="stoicC">C</div>
                            <div class="stoic-label">Context</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Row 2: Chart + Markov Matrix -->
        <div class="grid-2-1">
            <!-- Main Chart -->
            <div class="panel">
                <div class="panel-header">
                    <h3>Price Chart with Indicators</h3>
                    <span class="badge" id="chartBars">0 bars</span>
                </div>
                <div class="panel-body no-padding">
                    <div id="mainChart" class="chart-container"></div>
                </div>
            </div>
            
            <!-- Right Column: Matrix + Vision + Distribution -->
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Markov Matrix -->
                <div class="panel">
                    <div class="panel-header">
                        <h3>Markov Transition Matrix</h3>
                    </div>
                    <div class="panel-body" style="padding: 10px;">
                        <table class="markov-matrix" id="markovMatrix">
                            <thead>
                                <tr>
                                    <th>→</th>
                                    <th>BUL</th>
                                    <th>BER</th>
                                    <th>RNG</th>
                                    <th>VOL</th>
                                    <th>BRK</th>
                                    <th>REV</th>
                                </tr>
                            </thead>
                            <tbody id="matrixBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Vision API Config -->
                <div class="panel">
                    <div class="panel-header">
                        <h3>Vision API Config</h3>
                        <label class="toggle-switch">
                            <input type="checkbox" id="visionEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="panel-body">
                        <div class="config-group">
                            <div class="config-label">API Key</div>
                            <input type="password" class="config-input" id="visionApiKey" placeholder="sk-ant-...">
                        </div>
                        <div class="config-group">
                            <div class="config-label">Screenshot Interval (sec)</div>
                            <input type="number" class="config-input" id="visionInterval" value="60" min="10" max="300">
                        </div>
                        <div class="config-group">
                            <div class="config-label">Model</div>
                            <select class="config-select" id="visionModel">
                                <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                                <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                            </select>
                        </div>
                        <button class="control-btn btn-start" style="width: 100%; margin-top: 10px;" onclick="testVision()">Test Vision API</button>
                    </div>
                </div>
                
                <!-- Regime Distribution -->
                <div class="panel">
                    <div class="panel-header">
                        <h3>Regime Distribution</h3>
                    </div>
                    <div class="panel-body">
                        <div class="regime-bars" id="regimeBars">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Row 3: Indicator Management Tabs -->
        <div class="panel full-width">
            <div class="panel-header">
                <h3>Apex Signals - Indicator Management</h3>
                <span class="badge" id="indicatorCount">0 indicators</span>
            </div>
            <div class="panel-body">
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-btn active" data-tab="rsi">RSI</button>
                        <button class="tab-btn" data-tab="cci">CCI</button>
                        <button class="tab-btn" data-tab="stochastic">Stochastic</button>
                        <button class="tab-btn" data-tab="williams">Williams %R</button>
                        <button class="tab-btn" data-tab="momentum">Momentum</button>
                        <button class="tab-btn" data-tab="roc">ROC</button>
                        <button class="tab-btn" data-tab="macd">MACD</button>
                        <button class="tab-btn" data-tab="bollinger">Bollinger</button>
                        <button class="tab-btn" data-tab="atr">ATR</button>
                        <button class="tab-btn" data-tab="volume">Volume</button>
                        <button class="tab-btn" data-tab="all">ALL DATA</button>
                    </div>
                    
                    <div class="tab-content active" id="tab-rsi">
                        <div class="indicator-grid" id="rsiGrid"></div>
                    </div>
                    <div class="tab-content" id="tab-cci">
                        <div class="indicator-grid" id="cciGrid"></div>
                    </div>
                    <div class="tab-content" id="tab-stochastic">
                        <div class="indicator-grid" id="stochasticGrid"></div>
                    </div>
                    <div class="tab-content" id="tab-williams">
                        <div class="indicator-grid" id="williamsGrid"></div>
                    </div>
                    <div class="tab-content" id="tab-momentum">
                        <div class="indicator-grid" id="momentumGrid"></div>
                    </div>
                    <div class="tab-content" id="tab-roc">
                        <div class="indicator-grid" id="rocGrid"></div>
                    </div>
                    <div class="tab-content" id="tab-macd">
                        <div class="indicator-grid" id="macdGrid"></div>
                    </div>
                    <div class="tab-content" id="tab-bollinger">
                        <div class="indicator-grid" id="bollingerGrid"></div>
                    </div>
                    <div class="tab-content" id="tab-atr">
                        <div class="indicator-grid" id="atrGrid"></div>
                    </div>
                    <div class="tab-content" id="tab-volume">
                        <div class="indicator-grid" id="volumeGrid"></div>
                    </div>
                    <div class="tab-content" id="tab-all">
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="data-table" id="allDataTable">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Close</th>
                                        <th>RSI 14</th>
                                        <th>CCI 14</th>
                                        <th>Stoch K</th>
                                        <th>MACD</th>
                                        <th>ATR 14</th>
                                        <th>Supertrend</th>
                                    </tr>
                                </thead>
                                <tbody id="allDataBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Footer -->
        <div class="panel" style="margin-top: 15px;">
            <div class="status-footer">
                <div class="status-item">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="connectionStatus">Connecting...</span>
                </div>
                <div class="status-item">
                    <span>Last Update: <span id="lastUpdate">--</span></span>
                </div>
                <div class="status-item">
                    <span>Refresh: <span id="refreshRate">5s</span></span>
                </div>
                <div class="status-item">
                    <span>Condition: κ = <span id="conditionNumber">1.000</span></span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ================================================================
        // STATE
        // ================================================================
        let isLive = false;
        let liveInterval = null;
        let currentTimeframe = '15m';
        let chartData = { core: [], basic: [], advanced: [] };
        
        const STATES = ['bullish', 'bearish', 'ranging', 'volatile', 'breakout_pending', 'reversal_forming'];
        const STATE_LABELS = ['BUL', 'BER', 'RNG', 'VOL', 'BRK', 'REV'];
        const STATE_COLORS = ['#4ecdc4', '#ff6b6b', '#ffd700', '#ff9f43', '#a29bfe', '#fd79a8'];
        
        // ================================================================
        // TAB HANDLING
        // ================================================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('tab-' + this.dataset.tab).classList.add('active');
            });
        });
        
        // ================================================================
        // TIMEFRAME CHANGE
        // ================================================================
        document.getElementById('timeframeSelect').addEventListener('change', function() {
            currentTimeframe = this.value;
            if (isLive) {
                loadAllData();
            }
        });
        
        // ================================================================
        // START/STOP LIVE
        // ================================================================
        function startLive() {
            isLive = true;
            document.getElementById('btnStart').classList.add('active');
            document.getElementById('statusDot').classList.remove('offline');
            document.getElementById('connectionStatus').textContent = 'Live';
            
            loadAllData();
            liveInterval = setInterval(loadAllData, 5000);
        }
        
        function stopLive() {
            isLive = false;
            document.getElementById('btnStart').classList.remove('active');
            document.getElementById('statusDot').classList.add('offline');
            document.getElementById('connectionStatus').textContent = 'Stopped';
            
            if (liveInterval) {
                clearInterval(liveInterval);
                liveInterval = null;
            }
        }
        
        // ================================================================
        // LOAD ALL DATA
        // ================================================================
        async function loadAllData() {
            try {
                // Load chart data
                const [coreRes, basicRes, advancedRes] = await Promise.all([
                    fetch(`/api/core?timeframe=${currentTimeframe}&limit=200`),
                    fetch(`/api/basic?timeframe=${currentTimeframe}&limit=200`),
                    fetch(`/api/advanced?timeframe=${currentTimeframe}&limit=200`)
                ]);
                
                const coreData = await coreRes.json();
                const basicData = await basicRes.json();
                const advancedData = await advancedRes.json();
                
                if (coreData.success) chartData.core = coreData.data.reverse();
                if (basicData.success) chartData.basic = basicData.data.reverse();
                if (advancedData.success) chartData.advanced = advancedData.data.reverse();
                
                // Update chart
                updateChart();
                
                // Update indicators
                updateIndicators();
                
                // Update all data table
                updateAllDataTable();
                
                // Load Wizaude status
                await loadWizaudeData();
                
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                document.getElementById('chartBars').textContent = chartData.core.length + ' bars';
                
            } catch (err) {
                console.error('Error loading data:', err);
            }
        }
        
        // ================================================================
        // LOAD WIZAUDE DATA
        // ================================================================
        async function loadWizaudeData() {
            try {
                const [statusRes, signalRes, regimeRes, stoicRes] = await Promise.all([
                    fetch('/api/wizaude/status').catch(() => null),
                    fetch('/api/wizaude/signal').catch(() => null),
                    fetch('/api/wizaude/regime').catch(() => null),
                    fetch('/api/wizaude/stoic').catch(() => null)
                ]);
                
                if (statusRes && statusRes.ok) {
                    const status = await statusRes.json();
                    updateStatus(status);
                }
                
                if (signalRes && signalRes.ok) {
                    const signal = await signalRes.json();
                    updateSignal(signal);
                }
                
                if (regimeRes && regimeRes.ok) {
                    const regime = await regimeRes.json();
                    updateRegime(regime);
                }
                
                if (stoicRes && stoicRes.ok) {
                    const stoic = await stoicRes.json();
                    updateStoic(stoic);
                }
                
            } catch (err) {
                console.error('Error loading Wizaude data:', err);
            }
        }
        
        // ================================================================
        // UPDATE CHART
        // ================================================================
        function updateChart() {
            if (chartData.core.length === 0) return;
            
            const timestamps = chartData.core.map(d => d.timestamp);
            const opens = chartData.core.map(d => parseFloat(d.open));
            const highs = chartData.core.map(d => parseFloat(d.high));
            const lows = chartData.core.map(d => parseFloat(d.low));
            const closes = chartData.core.map(d => parseFloat(d.close));
            const volumes = chartData.core.map(d => parseFloat(d.volume));
            
            const traces = [];
            
            // Candlestick
            traces.push({
                type: 'candlestick',
                x: timestamps,
                open: opens,
                high: highs,
                low: lows,
                close: closes,
                name: 'Price',
                increasing: { line: { color: '#4ecdc4' } },
                decreasing: { line: { color: '#ff6b6b' } },
                yaxis: 'y'
            });
            
            // EMAs from basic
            if (chartData.basic.length > 0) {
                const emaShort = chartData.basic.map(d => parseFloat(d.ema_short));
                const emaMedium = chartData.basic.map(d => parseFloat(d.ema_medium));
                const basicTimestamps = chartData.basic.map(d => d.timestamp);
                
                traces.push({
                    type: 'scatter',
                    mode: 'lines',
                    x: basicTimestamps,
                    y: emaShort,
                    name: 'EMA Short',
                    line: { color: 'cyan', width: 1 },
                    yaxis: 'y'
                });
                
                traces.push({
                    type: 'scatter',
                    mode: 'lines',
                    x: basicTimestamps,
                    y: emaMedium,
                    name: 'EMA Medium',
                    line: { color: 'orange', width: 1 },
                    yaxis: 'y'
                });
            }
            
            // Bollinger Bands from advanced
            if (chartData.advanced.length > 0) {
                const advTimestamps = chartData.advanced.map(d => d.timestamp);
                const bbUpper = chartData.advanced.map(d => parseFloat(d.bb_upper_20));
                const bbLower = chartData.advanced.map(d => parseFloat(d.bb_lower_20));
                const rsi14 = chartData.advanced.map(d => parseFloat(d.rsi_14));
                
                traces.push({
                    type: 'scatter',
                    mode: 'lines',
                    x: advTimestamps,
                    y: bbUpper,
                    name: 'BB Upper',
                    line: { color: 'rgba(128,128,128,0.5)', width: 1, dash: 'dash' },
                    yaxis: 'y'
                });
                
                traces.push({
                    type: 'scatter',
                    mode: 'lines',
                    x: advTimestamps,
                    y: bbLower,
                    name: 'BB Lower',
                    line: { color: 'rgba(128,128,128,0.5)', width: 1, dash: 'dash' },
                    fill: 'tonexty',
                    fillcolor: 'rgba(128,128,128,0.1)',
                    yaxis: 'y'
                });
                
                // RSI subplot
                traces.push({
                    type: 'scatter',
                    mode: 'lines',
                    x: advTimestamps,
                    y: rsi14,
                    name: 'RSI 14',
                    line: { color: '#a29bfe', width: 2 },
                    yaxis: 'y2'
                });
            }
            
            // Volume
            const volumeColors = closes.map((c, i) => c >= opens[i] ? 'rgba(78,205,196,0.5)' : 'rgba(255,107,107,0.5)');
            traces.push({
                type: 'bar',
                x: timestamps,
                y: volumes,
                name: 'Volume',
                marker: { color: volumeColors },
                yaxis: 'y3'
            });
            
            const layout = {
                height: 500,
                showlegend: true,
                legend: { orientation: 'h', y: 1.1, x: 0.5, xanchor: 'center' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(10,10,20,0.5)',
                font: { color: '#e0e0e0' },
                margin: { l: 60, r: 60, t: 30, b: 50 },
                xaxis: { 
                    rangeslider: { visible: false },
                    gridcolor: 'rgba(184,134,11,0.1)'
                },
                yaxis: { 
                    title: 'Price',
                    domain: [0.35, 1],
                    gridcolor: 'rgba(184,134,11,0.1)'
                },
                yaxis2: {
                    title: 'RSI',
                    domain: [0.18, 0.32],
                    range: [0, 100],
                    gridcolor: 'rgba(184,134,11,0.1)'
                },
                yaxis3: {
                    title: 'Vol',
                    domain: [0, 0.15],
                    gridcolor: 'rgba(184,134,11,0.1)'
                },
                shapes: [
                    { type: 'line', y0: 70, y1: 70, x0: 0, x1: 1, xref: 'paper', yref: 'y2', line: { color: '#ff6b6b', dash: 'dash', width: 1 } },
                    { type: 'line', y0: 30, y1: 30, x0: 0, x1: 1, xref: 'paper', yref: 'y2', line: { color: '#4ecdc4', dash: 'dash', width: 1 } }
                ]
            };
            
            Plotly.react('mainChart', traces, layout, { responsive: true });
        }
        
        // ================================================================
        // UPDATE INDICATORS
        // ================================================================
        function updateIndicators() {
            if (chartData.advanced.length === 0) return;
            
            const latest = chartData.advanced[chartData.advanced.length - 1];
            let totalIndicators = 0;
            
            // RSI
            const rsiGrid = document.getElementById('rsiGrid');
            rsiGrid.innerHTML = '';
            for (let i = 1; i <= 14; i++) {
                const val = parseFloat(latest[`rsi_${i}`]);
                if (!isNaN(val)) {
                    rsiGrid.appendChild(createIndicatorCard(`RSI ${i}`, val, 'rsi', val));
                    totalIndicators++;
                }
            }
            
            // CCI
            const cciGrid = document.getElementById('cciGrid');
            cciGrid.innerHTML = '';
            for (let i = 1; i <= 14; i++) {
                const val = parseFloat(latest[`cci_${i}`]);
                if (!isNaN(val)) {
                    cciGrid.appendChild(createIndicatorCard(`CCI ${i}`, val, 'cci', val));
                    totalIndicators++;
                }
            }
            
            // Stochastic
            const stochasticGrid = document.getElementById('stochasticGrid');
            stochasticGrid.innerHTML = '';
            for (let i = 1; i <= 14; i++) {
                const val = parseFloat(latest[`stoch_k_${i}`]);
                if (!isNaN(val)) {
                    stochasticGrid.appendChild(createIndicatorCard(`Stoch K ${i}`, val, 'stoch', val));
                    totalIndicators++;
                }
            }
            
            // Williams %R
            const williamsGrid = document.getElementById('williamsGrid');
            williamsGrid.innerHTML = '';
            for (let i = 1; i <= 14; i++) {
                const val = parseFloat(latest[`williams_r_${i}`]);
                if (!isNaN(val)) {
                    williamsGrid.appendChild(createIndicatorCard(`Will R ${i}`, val, 'williams', val));
                    totalIndicators++;
                }
            }
            
            // Momentum
            const momentumGrid = document.getElementById('momentumGrid');
            momentumGrid.innerHTML = '';
            for (let i = 1; i <= 14; i++) {
                const val = parseFloat(latest[`momentum_${i}`]);
                if (!isNaN(val)) {
                    momentumGrid.appendChild(createIndicatorCard(`Mom ${i}`, val, 'momentum', val));
                    totalIndicators++;
                }
            }
            
            // ROC
            const rocGrid = document.getElementById('rocGrid');
            rocGrid.innerHTML = '';
            for (let i = 1; i <= 14; i++) {
                const val = parseFloat(latest[`roc_${i}`]);
                if (!isNaN(val)) {
                    rocGrid.appendChild(createIndicatorCard(`ROC ${i}`, val, 'roc', val));
                    totalIndicators++;
                }
            }
            
            // MACD
            const macdGrid = document.getElementById('macdGrid');
            macdGrid.innerHTML = '';
            ['macd_line_12_26', 'macd_signal_12_26_9', 'macd_histogram_12_26_9'].forEach(key => {
                const val = parseFloat(latest[key]);
                if (!isNaN(val)) {
                    const name = key.replace('macd_', '').replace(/_/g, ' ').toUpperCase();
                    macdGrid.appendChild(createIndicatorCard(name, val, 'momentum', val));
                    totalIndicators++;
                }
            });
            
            // Bollinger
            const bollingerGrid = document.getElementById('bollingerGrid');
            bollingerGrid.innerHTML = '';
            ['bb_upper_20', 'bb_middle_20', 'bb_lower_20', 'bb_width_20'].forEach(key => {
                const val = parseFloat(latest[key]);
                if (!isNaN(val)) {
                    const name = key.replace('bb_', 'BB ').replace(/_/g, ' ').toUpperCase();
                    bollingerGrid.appendChild(createIndicatorCard(name, val, 'neutral', null));
                    totalIndicators++;
                }
            });
            
            // ATR
            const atrGrid = document.getElementById('atrGrid');
            atrGrid.innerHTML = '';
            for (let i = 1; i <= 14; i++) {
                const val = parseFloat(latest[`atr_${i}`]);
                if (!isNaN(val)) {
                    atrGrid.appendChild(createIndicatorCard(`ATR ${i}`, val, 'neutral', null));
                    totalIndicators++;
                }
            }
            
            // Volume
            const volumeGrid = document.getElementById('volumeGrid');
            volumeGrid.innerHTML = '';
            for (let i = 1; i <= 14; i++) {
                const val = parseFloat(latest[`volume_ma_${i}`]);
                if (!isNaN(val)) {
                    volumeGrid.appendChild(createIndicatorCard(`Vol MA ${i}`, val, 'neutral', null));
                    totalIndicators++;
                }
            }
            if (latest.obv) {
                volumeGrid.appendChild(createIndicatorCard('OBV', parseFloat(latest.obv), 'neutral', null));
                totalIndicators++;
            }
            
            document.getElementById('indicatorCount').textContent = totalIndicators + ' indicators';
            
            // Calculate dynamic score
            calculateScore(latest);
        }
        
        function createIndicatorCard(name, value, type, rawValue) {
            const card = document.createElement('div');
            let colorClass = 'neutral';
            
            if (type === 'rsi') {
                colorClass = rawValue > 70 ? 'negative' : rawValue < 30 ? 'positive' : 'neutral';
            } else if (type === 'cci') {
                colorClass = rawValue > 100 ? 'positive' : rawValue < -100 ? 'negative' : 'neutral';
            } else if (type === 'stoch') {
                colorClass = rawValue > 80 ? 'negative' : rawValue < 20 ? 'positive' : 'neutral';
            } else if (type === 'williams') {
                colorClass = rawValue > -20 ? 'negative' : rawValue < -80 ? 'positive' : 'neutral';
            } else if (type === 'momentum' || type === 'roc') {
                colorClass = rawValue > 0 ? 'positive' : rawValue < 0 ? 'negative' : 'neutral';
            }
            
            const formattedValue = Math.abs(value) < 1 ? value.toFixed(4) : 
                                   Math.abs(value) < 100 ? value.toFixed(2) : 
                                   value.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            card.className = `indicator-card ${colorClass}`;
            card.innerHTML = `
                <div class="indicator-name">${name}</div>
                <div class="indicator-value ${colorClass}">${formattedValue}</div>
            `;
            return card;
        }
        
        // ================================================================
        // CALCULATE DYNAMIC SCORE
        // ================================================================
        function calculateScore(latest) {
            let score = 0;
            let factors = 0;
            
            // RSI contribution
            const rsi14 = parseFloat(latest.rsi_14);
            if (!isNaN(rsi14)) {
                if (rsi14 < 30) score += 20;
                else if (rsi14 > 70) score -= 20;
                else score += (50 - rsi14) * 0.4;
                factors++;
            }
            
            // CCI contribution
            const cci14 = parseFloat(latest.cci_14);
            if (!isNaN(cci14)) {
                if (cci14 > 100) score += 15;
                else if (cci14 < -100) score -= 15;
                factors++;
            }
            
            // MACD contribution
            const macdHist = parseFloat(latest.macd_histogram_12_26_9);
            if (!isNaN(macdHist)) {
                score += macdHist > 0 ? 10 : -10;
                factors++;
            }
            
            // Momentum contribution
            const mom14 = parseFloat(latest.momentum_14);
            if (!isNaN(mom14)) {
                score += mom14 > 0 ? 10 : -10;
                factors++;
            }
            
            // Normalize score
            const normalizedScore = factors > 0 ? Math.round(score / factors * 10) : 0;
            const boundedScore = Math.max(-100, Math.min(100, normalizedScore));
            
            document.getElementById('tradeScore').textContent = boundedScore;
            
            // Gate zone based on absolute score
            const gate = Math.ceil(Math.abs(boundedScore) / 10) || 1;
            document.getElementById('scoreGate').textContent = 'Gate ' + gate;
        }
        
        // ================================================================
        // UPDATE ALL DATA TABLE
        // ================================================================
        function updateAllDataTable() {
            const tbody = document.getElementById('allDataBody');
            tbody.innerHTML = '';
            
            const data = chartData.advanced.slice(-20).reverse();
            const coreData = chartData.core.slice(-20).reverse();
            const basicData = chartData.basic.slice(-20).reverse();
            
            data.forEach((row, i) => {
                const core = coreData[i] || {};
                const basic = basicData[i] || {};
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.timestamp || '--'}</td>
                    <td>${core.close ? parseFloat(core.close).toFixed(2) : '--'}</td>
                    <td>${row.rsi_14 ? parseFloat(row.rsi_14).toFixed(2) : '--'}</td>
                    <td>${row.cci_14 ? parseFloat(row.cci_14).toFixed(2) : '--'}</td>
                    <td>${row.stoch_k_14 ? parseFloat(row.stoch_k_14).toFixed(2) : '--'}</td>
                    <td>${row.macd_line_12_26 ? parseFloat(row.macd_line_12_26).toFixed(4) : '--'}</td>
                    <td>${row.atr_14 ? parseFloat(row.atr_14).toFixed(4) : '--'}</td>
                    <td>${basic.supertrend || '--'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // ================================================================
        // UPDATE STATUS
        // ================================================================
        function updateStatus(data) {
            document.getElementById('cycles').textContent = data.cycles || 0;
            document.getElementById('persistence').textContent = (data.persistence || 0).toFixed(2);
            document.getElementById('conditionNumber').textContent = (data.condition_number || 1).toFixed(3);
            
            const regime = data.regime || 'ranging';
            const regimeEl = document.getElementById('regimeName');
            regimeEl.textContent = regime.toUpperCase().replace('_', ' ');
            regimeEl.className = 'regime-name regime-' + regime.split('_')[0];
            
            const stateId = STATES.indexOf(regime);
            document.getElementById('stateId').textContent = stateId >= 0 ? stateId : '?';
            
            // Update Markov matrix highlighting
            updateMarkovMatrix(stateId);
        }
        
        function updateSignal(data) {
            const signal = data.signal || data.last_signal || 'HOLD';
            const confidence = data.confidence || 50;
            const northStar = data.north_star || 1.0;
            const gate = data.gate_zone || '--';
            
            const badge = document.getElementById('signalBadge');
            badge.textContent = signal;
            badge.className = 'signal-badge signal-' + signal.toLowerCase();
            
            document.getElementById('confidenceValue').textContent = confidence + '%';
            const fill = document.getElementById('confidenceFill');
            fill.style.width = confidence + '%';
            fill.className = 'confidence-fill ' + (confidence > 70 ? 'high' : confidence > 40 ? 'medium' : 'low');
            
            document.getElementById('northStar').textContent = northStar.toFixed(3);
            document.getElementById('signalGate').textContent = 'Gate: ' + gate;
            
            // Update PF/NP display
            if (data.pf) document.getElementById('profitFactor').textContent = data.pf.toFixed(2);
            if (data.np) document.getElementById('netProfit').textContent = '$' + data.np.toFixed(0);
        }
        
        function updateStoic(data) {
            const factors = data.factors || {};
            
            ['S', 'T', 'O', 'I', 'C'].forEach(letter => {
                const factor = factors[letter] || { pass: true };
                const el = document.getElementById('stoic' + letter);
                el.className = 'stoic-letter ' + (factor.pass ? 'stoic-pass' : 'stoic-fail');
            });
            
            const allPass = Object.values(factors).every(f => f.pass !== false);
            document.getElementById('stoicStatus').textContent = allPass ? 'PASS' : 'FAIL';
            document.getElementById('stoicStatus').style.background = allPass ? 'rgba(78,205,196,0.2)' : 'rgba(255,107,107,0.2)';
            document.getElementById('stoicStatus').style.color = allPass ? '#4ecdc4' : '#ff6b6b';
        }
        
        function updateRegime(data) {
            const dist = data.distribution || {};
            
            const barsContainer = document.getElementById('regimeBars');
            barsContainer.innerHTML = '';
            
            const regimes = [
                { key: 'bullish', label: 'Bullish', class: 'bar-bullish' },
                { key: 'bearish', label: 'Bearish', class: 'bar-bearish' },
                { key: 'ranging', label: 'Ranging', class: 'bar-ranging' },
                { key: 'volatile', label: 'Volatile', class: 'bar-volatile' },
                { key: 'breakout_pending', label: 'Breakout', class: 'bar-breakout' },
                { key: 'reversal_forming', label: 'Reversal', class: 'bar-reversal' }
            ];
            
            regimes.forEach(r => {
                const pct = dist[r.key] || 0;
                const item = document.createElement('div');
                item.className = 'regime-bar-item';
                item.innerHTML = `
                    <div class="regime-bar-label">${r.label}</div>
                    <div class="regime-bar-track">
                        <div class="regime-bar-fill ${r.class}" style="width: ${pct}%;">${pct > 5 ? pct + '%' : ''}</div>
                    </div>
                `;
                barsContainer.appendChild(item);
            });
        }
        
        function updateMarkovMatrix(currentState) {
            const tbody = document.getElementById('matrixBody');
            tbody.innerHTML = '';
            
            // Default probabilities
            const defaultProbs = [
                [0.70, 0.05, 0.10, 0.05, 0.05, 0.05],
                [0.05, 0.70, 0.10, 0.05, 0.05, 0.05],
                [0.15, 0.15, 0.50, 0.05, 0.10, 0.05],
                [0.15, 0.15, 0.10, 0.40, 0.10, 0.10],
                [0.25, 0.25, 0.05, 0.15, 0.20, 0.10],
                [0.20, 0.20, 0.15, 0.15, 0.10, 0.20]
            ];
            
            STATE_LABELS.forEach((label, i) => {
                const tr = document.createElement('tr');
                if (i === currentState) tr.className = 'current-row';
                
                let html = `<th>${label}</th>`;
                defaultProbs[i].forEach((prob, j) => {
                    const colorClass = prob > 0.3 ? 'prob-high' : prob > 0.1 ? 'prob-medium' : 'prob-low';
                    const highlight = (i === currentState && j === currentState) ? 'highlight' : '';
                    html += `<td class="${colorClass} ${highlight}">${prob.toFixed(2)}</td>`;
                });
                
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }
        
        // ================================================================
        // VISION API TEST
        // ================================================================
        async function testVision() {
            const apiKey = document.getElementById('visionApiKey').value;
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }
            
            document.getElementById('loadingOverlay').classList.add('active');
            
            try {
                // This would call your vision API endpoint
                const response = await fetch('/api/wizaude/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true, api_key: apiKey })
                });
                
                if (response.ok) {
                    alert('Vision API test successful!');
                } else {
                    alert('Vision API test failed');
                }
            } catch (err) {
                console.error('Vision test error:', err);
                alert('Vision API test error: ' + err.message);
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }
        
        // ================================================================
        // INIT
        // ================================================================
        updateMarkovMatrix(2); // Default to ranging
        
        // Auto-start on load
        setTimeout(() => {
            startLive();
        }, 500);
    </script>
</body>
</html>
