<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORRA / CYTO</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <style>
/* ═══════════════════════════════════════════════════════════════
   TOKENS - Matching APEX design system
   ═══════════════════════════════════════════════════════════════ */
:root {
    --base-core: #1C1E22;
    --base-secondary: #22252A;
    --base-tertiary: #2A2D33;
    --base-elevated: #32363D;
    --shadow-dark: #0D0F12;
    --shadow-light: #2E3239;
    --text-primary: #F2F4F7;
    --text-secondary: #A4A9B3;
    --text-tertiary: #6B7280;
    --text-disabled: #5A5F6A;
    --accent-mint: #ADEBB3;
    --accent-teal: #46B4AF;
    --accent-gold: #d4af37;
    --accent-blue: #3A5F8A;
    --font-sans: 'Inter', -apple-system, sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
    --shadow-raised-sm: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
    --shadow-raised-md: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
    --shadow-inset-sm: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
    --shadow-inset-md: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
    --panel-transition: 0.3s cubic-bezier(0.33, 1, 0.68, 1);
}

/* ═══════════════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════════════ */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    background: var(--base-core);
    color: var(--text-primary);
    font-family: var(--font-sans);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
}

/* ═══════════════════════════════════════════════════════════════
   LAYOUT - Viewport + Control Panel
   ═══════════════════════════════════════════════════════════════ */
#app {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

#viewport {
    flex: 1;
    position: relative;
    background: linear-gradient(180deg, #0d0d1a 0%, var(--base-core) 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 0;
    transition: flex var(--panel-transition);
}

/* ═══════════════════════════════════════════════════════════════
   VIEWPORT HUD
   ═══════════════════════════════════════════════════════════════ */
#hud-top {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    z-index: 10;
}
#hud-top .clock {
    font-size: 24px;
    font-weight: 700;
    color: var(--accent-gold);
    font-family: var(--font-mono);
    letter-spacing: 0.05em;
}
#hud-top .date {
    font-size: 11px;
    color: var(--text-tertiary);
    margin-top: 2px;
}

#hud-right {
    position: absolute;
    top: 12px;
    right: 14px;
    background: rgba(0,0,0,0.5);
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.04);
    z-index: 10;
}
#hud-right .mode { font-size: 11px; font-weight: 600; color: var(--accent-gold); }
#hud-right .detail { font-size: 10px; color: var(--text-tertiary); margin-top: 2px; }

#hud-left {
    position: absolute;
    top: 12px;
    left: 14px;
    z-index: 10;
}
.epoch-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: rgba(0,0,0,0.5);
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.04);
    font-size: 10px;
    color: var(--text-tertiary);
}
.epoch-badge .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--text-disabled);
}
.epoch-badge .dot.live { background: var(--accent-teal); box-shadow: 0 0 6px rgba(70,180,175,0.5); }

/* ═══════════════════════════════════════════════════════════════
   CANVAS
   ═══════════════════════════════════════════════════════════════ */
#canvas {
    display: block;
}

/* ═══════════════════════════════════════════════════════════════
   DIVIDER
   ═══════════════════════════════════════════════════════════════ */
#divider {
    height: 6px;
    background: var(--base-secondary);
    cursor: ns-resize;
    display: flex;
    justify-content: center;
    align-items: center;
    border-top: 1px solid rgba(255,255,255,0.04);
    border-bottom: 1px solid rgba(255,255,255,0.04);
    flex-shrink: 0;
    z-index: 20;
}
#divider .handle {
    width: 40px;
    height: 3px;
    border-radius: 2px;
    background: var(--base-elevated);
}

/* ═══════════════════════════════════════════════════════════════
   CONTROL PANEL - MINIMIZED BAR
   ═══════════════════════════════════════════════════════════════ */
#control-bar {
    height: 36px;
    background: var(--base-secondary);
    border-top: 1px solid rgba(255,255,255,0.06);
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 10px;
    flex-shrink: 0;
    z-index: 20;
    cursor: pointer;
    transition: opacity var(--panel-transition);
}
#control-bar .bar-title {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-tertiary);
}
#control-bar .bar-stats {
    display: flex;
    gap: 14px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-disabled);
}
#control-bar .bar-stats .val { color: var(--accent-teal); }
#control-bar .expand-icon {
    margin-left: auto;
    width: 20px; height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    background: rgba(255,255,255,0.04);
    color: var(--text-tertiary);
    font-size: 12px;
    transition: all 0.15s ease;
}
#control-bar:hover .expand-icon {
    background: rgba(255,255,255,0.08);
    color: var(--text-secondary);
}

/* ═══════════════════════════════════════════════════════════════
   CONTROL PANEL - EXPANDED
   ═══════════════════════════════════════════════════════════════ */
#control-panel {
    height: 0;
    background: #16181c;
    overflow: hidden;
    transition: height var(--panel-transition);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
}
#control-panel.expanded {
    height: 50vh;
}

/* Panel Header */
.cp-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: rgba(18, 20, 24, 0.95);
    border-bottom: 1px solid rgba(255,255,255,0.06);
    flex-shrink: 0;
}
.cp-header__left {
    display: flex;
    align-items: center;
    gap: 10px;
}
.cp-header__title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
}
.cp-header__right {
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Minimize button */
.cp-btn {
    padding: 5px 10px;
    background: var(--base-secondary);
    border: none;
    border-radius: 6px;
    color: var(--text-tertiary);
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow-raised-sm);
    transition: all 0.15s ease;
    font-family: var(--font-sans);
    letter-spacing: 0.5px;
    text-transform: uppercase;
}
.cp-btn:hover { color: var(--text-secondary); }
.cp-btn.active {
    box-shadow: var(--shadow-inset-sm);
    color: var(--accent-teal);
}
.cp-btn.danger { color: #f87171; }
.cp-btn.danger:hover { color: #ff9999; }

/* Panel Body - 2 column grid matching APEX database panels */
.cp-body {
    display: grid;
    grid-template-columns: 300px 1fr;
    flex: 1;
    min-height: 0;
    overflow: hidden;
}

/* ═══════════════════════════════════════════════════════════════
   LEFT COLUMN - BROWSER
   ═══════════════════════════════════════════════════════════════ */
.cp-browser {
    display: flex;
    flex-direction: column;
    border-right: 1px solid rgba(255,255,255,0.06);
    min-height: 0;
    overflow: hidden;
}

/* Class tabs */
.class-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
    padding: 8px;
    background: rgba(0,0,0,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.04);
    flex-shrink: 0;
}
.class-tab {
    padding: 5px 10px;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: var(--text-tertiary);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: var(--font-sans);
}
.class-tab:hover { color: var(--text-secondary); background: rgba(255,255,255,0.04); }
.class-tab.active { color: var(--accent-teal); background: rgba(70,180,175,0.1); }

/* Instance list */
.instance-list {
    flex: 1;
    overflow-y: auto;
    padding: 6px;
}
.instance-list::-webkit-scrollbar { width: 4px; }
.instance-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 2px; }

.instance-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    margin-bottom: 4px;
    background: var(--base-secondary);
    border-radius: 8px;
    cursor: pointer;
    box-shadow: var(--shadow-raised-sm);
    transition: all 0.15s ease;
    border: 1px solid transparent;
}
.instance-card:hover { border-color: rgba(255,255,255,0.06); }
.instance-card.selected {
    box-shadow: var(--shadow-inset-sm);
    border-color: rgba(70,180,175,0.2);
}
.instance-card__name {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-primary);
}
.instance-card__status {
    font-size: 9px;
    font-weight: 600;
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-disabled);
}
.instance-card__status.active { color: var(--accent-teal); }

/* Add instance */
.add-instance-row {
    display: flex;
    gap: 4px;
    padding: 6px;
    border-top: 1px solid rgba(255,255,255,0.04);
    flex-shrink: 0;
}
.add-instance-row input {
    flex: 1;
    padding: 6px 8px;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 4px;
    color: var(--text-primary);
    font-size: 11px;
    font-family: var(--font-sans);
    outline: none;
}
.add-instance-row input:focus { border-color: rgba(70,180,175,0.3); }
.add-instance-row input::placeholder { color: var(--text-disabled); }

/* Browser stats footer */
.browser-stats {
    display: flex;
    gap: 12px;
    padding: 6px 10px;
    background: rgba(0,0,0,0.2);
    border-top: 1px solid rgba(255,255,255,0.04);
    flex-shrink: 0;
}
.browser-stat {
    text-align: center;
}
.browser-stat__label {
    font-size: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-disabled);
}
.browser-stat__value {
    font-size: 13px;
    font-weight: 700;
    color: var(--accent-teal);
    font-family: var(--font-mono);
}

/* ═══════════════════════════════════════════════════════════════
   RIGHT COLUMN - DATA VIEW
   ═══════════════════════════════════════════════════════════════ */
.cp-data {
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
}

/* Data header with tabs */
.data-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: rgba(18, 20, 24, 0.6);
    border-bottom: 1px solid rgba(255,255,255,0.06);
    flex-shrink: 0;
}
.data-tabs {
    display: flex;
    gap: 2px;
    background: rgba(0,0,0,0.3);
    padding: 3px;
    border-radius: 6px;
}
.data-tab {
    padding: 5px 10px;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: var(--text-tertiary);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: var(--font-sans);
}
.data-tab:hover { color: var(--text-secondary); background: rgba(255,255,255,0.05); }
.data-tab.active { color: var(--text-primary); background: rgba(255,255,255,0.1); }

/* Time window selector */
.time-selector {
    display: flex;
    gap: 2px;
    background: rgba(0,0,0,0.3);
    padding: 3px;
    border-radius: 6px;
}
.time-btn {
    padding: 4px 8px;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: var(--text-tertiary);
    font-size: 10px;
    font-weight: 600;
    font-family: var(--font-mono);
    cursor: pointer;
    transition: all 0.15s ease;
}
.time-btn:hover { color: var(--text-secondary); }
.time-btn.active { color: var(--accent-gold); background: rgba(212,175,55,0.1); }

/* Data content area */
.data-content {
    flex: 1;
    overflow: auto;
    min-height: 0;
}
.data-content::-webkit-scrollbar { width: 6px; height: 6px; }
.data-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }

/* Data table */
.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    font-family: var(--font-mono);
}
.data-table thead { position: sticky; top: 0; z-index: 10; }
.data-table th {
    background: linear-gradient(180deg, rgba(30,32,36,0.98), rgba(22,24,28,0.95));
    color: var(--text-tertiary);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    white-space: nowrap;
}
.data-table td {
    padding: 7px 12px;
    color: #c8ccd4;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    white-space: nowrap;
}
.data-table tbody tr:hover { background: rgba(255,255,255,0.03); }
.data-table tbody tr:nth-child(even) { background: rgba(0,0,0,0.12); }

/* Empty state */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 140px;
    color: var(--text-disabled);
    text-align: center;
    padding: 20px;
}
.empty-state__icon { font-size: 28px; opacity: 0.4; margin-bottom: 8px; }
.empty-state__title { font-size: 12px; font-weight: 600; color: var(--text-tertiary); }
.empty-state__sub { font-size: 11px; color: var(--text-disabled); margin-top: 4px; }

/* ═══════════════════════════════════════════════════════════════
   POSITION STATS BAR (inside data panel header)
   ═══════════════════════════════════════════════════════════════ */
.pos-stats {
    display: flex;
    gap: 16px;
    padding: 0 12px;
}
.pos-stat__label {
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-disabled);
}
.pos-stat__value {
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-gold);
    font-family: var(--font-mono);
}
    </style>
</head>
<body>
<div id="app">

    <!-- ═══════════════════════════════════════
         VIEWPORT - Torus Canvas
         ═══════════════════════════════════════ -->
    <div id="viewport">
        <div id="hud-top">
            <div class="clock" id="clock">--:--:--</div>
            <div class="date" id="date">Loading...</div>
        </div>
        <div id="hud-left">
            <div class="epoch-badge">
                <div class="dot" id="epochDot"></div>
                <span id="epochLabel">Epoch: waiting for data</span>
            </div>
        </div>
        <div id="hud-right">
            <div class="mode" id="viewMode">All Classes</div>
            <div class="detail" id="viewDetail">72h window</div>
        </div>
        <canvas id="canvas"></canvas>
    </div>

    <!-- ═══════════════════════════════════════
         DIVIDER
         ═══════════════════════════════════════ -->
    <div id="divider"><div class="handle"></div></div>

    <!-- ═══════════════════════════════════════
         CONTROL PANEL - EXPANDED
         ═══════════════════════════════════════ -->
    <div id="control-panel">
        <!-- Header -->
        <div class="cp-header">
            <div class="cp-header__left">
                <span class="cp-header__title">CytoBase</span>
                <div class="pos-stats">
                    <div class="pos-stat">
                        <div class="pos-stat__label">Layer</div>
                        <div class="pos-stat__value" id="statW">—</div>
                    </div>
                    <div class="pos-stat">
                        <div class="pos-stat__label">θ</div>
                        <div class="pos-stat__value" id="statTheta">—</div>
                    </div>
                    <div class="pos-stat">
                        <div class="pos-stat__label">Progress</div>
                        <div class="pos-stat__value" id="statProgress">—</div>
                    </div>
                    <div class="pos-stat">
                        <div class="pos-stat__label">Nodes</div>
                        <div class="pos-stat__value" id="statNodes">0</div>
                    </div>
                </div>
            </div>
            <div class="cp-header__right">
                <button class="cp-btn" id="btnMinimize" title="Minimize">▼</button>
            </div>
        </div>

        <!-- Body -->
        <div class="cp-body">
            <!-- Left: Browser -->
            <div class="cp-browser">
                <div class="class-tabs" id="classTabs"></div>
                <div class="instance-list" id="instanceList">
                    <div class="empty-state">
                        <div class="empty-state__icon">◇</div>
                        <div class="empty-state__title">Select a class</div>
                    </div>
                </div>
                <div class="add-instance-row">
                    <input type="text" id="newInstanceName" placeholder="New instance name...">
                    <button class="cp-btn" id="btnAddInstance" style="color:var(--accent-mint)">+</button>
                </div>
                <div class="browser-stats">
                    <div class="browser-stat">
                        <div class="browser-stat__label">Classes</div>
                        <div class="browser-stat__value" id="bsClasses">0</div>
                    </div>
                    <div class="browser-stat">
                        <div class="browser-stat__label">Instances</div>
                        <div class="browser-stat__value" id="bsInstances">0</div>
                    </div>
                    <div class="browser-stat">
                        <div class="browser-stat__label">Active</div>
                        <div class="browser-stat__value" id="bsActive">0</div>
                    </div>
                </div>
            </div>

            <!-- Right: Data View -->
            <div class="cp-data">
                <div class="data-header">
                    <div class="data-tabs">
                        <button class="data-tab active" data-tab="nodes">Nodes</button>
                        <button class="data-tab" data-tab="layers">Layers</button>
                        <button class="data-tab" data-tab="config">Config</button>
                    </div>
                    <div class="time-selector">
                        <button class="time-btn" data-hours="24">24H</button>
                        <button class="time-btn active" data-hours="72">72H</button>
                        <button class="time-btn" data-hours="168">1W</button>
                        <button class="time-btn" data-hours="0">ALL</button>
                    </div>
                </div>
                <div class="data-content" id="dataContent">
                    <div class="empty-state">
                        <div class="empty-state__icon">⊚</div>
                        <div class="empty-state__title">No data yet</div>
                        <div class="empty-state__sub">Data will appear when collection begins</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════
         CONTROL BAR - MINIMIZED
         ═══════════════════════════════════════ -->
    <div id="control-bar" style="display:none;">
        <span class="bar-title">CytoBase</span>
        <div class="bar-stats">
            <span>W<span class="val" id="barW">—</span></span>
            <span>θ <span class="val" id="barTheta">—</span></span>
            <span>Nodes <span class="val" id="barNodes">0</span></span>
        </div>
        <div class="expand-icon" title="Expand">▲</div>
    </div>
</div>

<script>
// ════════════════════════════════════════════════════════
// STATE
// ════════════════════════════════════════════════════════
const socket = io();
const PHI = 1.618033988749895;
const cvs = document.getElementById('canvas');
const ctx = cvs.getContext('2d');

let S = { w: 0, theta: 0, progress: 0, epoch: null, epochSet: false, nodeCount: 0, cycleHours: 72 };
let classes = [];
let instances = [];
let allInstances = [];
let nodes = [];
let selectedClass = null;
let selectedInstance = null;
let panelExpanded = true;
let timeWindow = 72;
let activeDataTab = 'nodes';

// ════════════════════════════════════════════════════════
// PANEL MINIMIZE / MAXIMIZE
// ════════════════════════════════════════════════════════
const panel = document.getElementById('control-panel');
const bar = document.getElementById('control-bar');
const divider = document.getElementById('divider');

function expandPanel() {
    panelExpanded = true;
    panel.classList.add('expanded');
    bar.style.display = 'none';
    divider.style.display = 'flex';
}

function minimizePanel() {
    panelExpanded = false;
    panel.classList.remove('expanded');
    bar.style.display = 'flex';
    divider.style.display = 'none';
}

document.getElementById('btnMinimize').addEventListener('click', minimizePanel);
bar.addEventListener('click', expandPanel);

// Start expanded
expandPanel();

// ════════════════════════════════════════════════════════
// DIVIDER DRAG
// ════════════════════════════════════════════════════════
let dragging = false;
divider.addEventListener('mousedown', (e) => {
    dragging = true;
    document.body.style.cursor = 'ns-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
});
document.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    const appH = document.getElementById('app').clientHeight;
    const panelH = appH - e.clientY - 6;
    const clamped = Math.max(100, Math.min(appH * 0.7, panelH));
    panel.style.height = clamped + 'px';
});
document.addEventListener('mouseup', () => {
    if (dragging) {
        dragging = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        resizeCanvas();
    }
});

// ════════════════════════════════════════════════════════
// CANVAS RESIZE
// ════════════════════════════════════════════════════════
function resizeCanvas() {
    const vp = document.getElementById('viewport');
    const sz = Math.min(vp.clientWidth, vp.clientHeight) - 30;
    cvs.width = sz;
    cvs.height = sz;
    render();
}
window.addEventListener('resize', resizeCanvas);
setTimeout(resizeCanvas, 50);

// Observer for viewport size changes (panel toggle)
new ResizeObserver(() => resizeCanvas()).observe(document.getElementById('viewport'));

// ════════════════════════════════════════════════════════
// ASSET CLASS TABS
// ════════════════════════════════════════════════════════
async function loadClasses() {
    const res = await fetch('/api/classes');
    classes = await res.json();
    document.getElementById('bsClasses').textContent = classes.length;
    renderClassTabs();
    
    // Also load all instances for count
    const res2 = await fetch('/api/instances');
    allInstances = await res2.json();
    document.getElementById('bsInstances').textContent = allInstances.length;
    document.getElementById('bsActive').textContent = allInstances.filter(i => i.status === 'active').length;
}

function renderClassTabs() {
    const cont = document.getElementById('classTabs');
    // Add "ALL" tab
    let html = `<button class="class-tab${!selectedClass ? ' active' : ''}" data-class="">ALL</button>`;
    classes.forEach(c => {
        html += `<button class="class-tab${selectedClass === c.id ? ' active' : ''}" data-class="${c.id}">${c.id.toUpperCase()}</button>`;
    });
    cont.innerHTML = html;
    
    cont.querySelectorAll('.class-tab').forEach(btn => {
        btn.addEventListener('click', () => {
            selectedClass = btn.dataset.class || null;
            selectedInstance = null;
            renderClassTabs();
            loadInstances();
            loadNodes();
        });
    });
}

// ════════════════════════════════════════════════════════
// INSTANCES
// ════════════════════════════════════════════════════════
async function loadInstances() {
    const url = selectedClass ? `/api/instances?class=${selectedClass}` : '/api/instances';
    const res = await fetch(url);
    instances = await res.json();
    renderInstances();
}

function renderInstances() {
    const cont = document.getElementById('instanceList');
    if (!instances.length) {
        cont.innerHTML = `<div class="empty-state">
            <div class="empty-state__icon">◇</div>
            <div class="empty-state__title">${selectedClass ? 'No instances in ' + selectedClass.toUpperCase() : 'Select a class'}</div>
            <div class="empty-state__sub">Add one below</div>
        </div>`;
        return;
    }
    cont.innerHTML = instances.map(inst => `
        <div class="instance-card${selectedInstance === inst.id ? ' selected' : ''}" data-id="${inst.id}">
            <div class="instance-card__name">${inst.name}</div>
            <div class="instance-card__status ${inst.status === 'active' ? 'active' : ''}">${inst.status}</div>
        </div>
    `).join('');
    
    cont.querySelectorAll('.instance-card').forEach(card => {
        card.addEventListener('click', () => {
            const id = parseInt(card.dataset.id);
            selectedInstance = selectedInstance === id ? null : id;
            renderInstances();
            loadNodes();
        });
    });
}

// Add instance
document.getElementById('btnAddInstance').addEventListener('click', async () => {
    const input = document.getElementById('newInstanceName');
    const name = input.value.trim();
    if (!name || !selectedClass) return;
    
    await fetch('/api/instances', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ asset_class_id: selectedClass, name })
    });
    input.value = '';
    loadInstances();
    loadClasses(); // refresh counts
});

document.getElementById('newInstanceName').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('btnAddInstance').click();
});

// ════════════════════════════════════════════════════════
// DATA TABS
// ════════════════════════════════════════════════════════
document.querySelectorAll('.data-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.data-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        activeDataTab = tab.dataset.tab;
        renderDataContent();
    });
});

// Time window
document.querySelectorAll('.time-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        timeWindow = parseInt(btn.dataset.hours);
        loadNodes();
    });
});

// ════════════════════════════════════════════════════════
// NODES DATA
// ════════════════════════════════════════════════════════
async function loadNodes() {
    let url = `/api/nodes?hours=${timeWindow || 999999}`;
    if (selectedClass) url += `&class=${selectedClass}`;
    if (selectedInstance) url += `&instance=${selectedInstance}`;
    const res = await fetch(url);
    nodes = await res.json();
    renderDataContent();
}

function renderDataContent() {
    const cont = document.getElementById('dataContent');
    
    if (activeDataTab === 'nodes') {
        if (!nodes.length) {
            cont.innerHTML = `<div class="empty-state">
                <div class="empty-state__icon">⊚</div>
                <div class="empty-state__title">No data yet</div>
                <div class="empty-state__sub">Data will appear when collection begins</div>
            </div>`;
            return;
        }
        cont.innerHTML = `<table class="data-table">
            <thead><tr>
                <th>Timestamp</th><th>Class</th><th>Instance</th><th>Type</th><th>W</th><th>θ</th><th>Content</th>
            </tr></thead>
            <tbody>${nodes.map(n => `<tr>
                <td>${formatTimestamp(n.timestamp)}</td>
                <td>${(n.asset_class_id || '').toUpperCase()}</td>
                <td>${n.instance_id || '—'}</td>
                <td>${n.node_type}</td>
                <td>W${n.w_layer}</td>
                <td>${Math.floor(n.theta)}°</td>
                <td>${n.content || '—'}</td>
            </tr>`).join('')}</tbody>
        </table>`;
    } else if (activeDataTab === 'layers') {
        // Layer summary
        const layerMap = {};
        nodes.forEach(n => {
            if (!layerMap[n.w_layer]) layerMap[n.w_layer] = { count: 0, classes: new Set() };
            layerMap[n.w_layer].count++;
            layerMap[n.w_layer].classes.add(n.asset_class_id);
        });
        const layers = Object.entries(layerMap).sort((a,b) => parseInt(b[0]) - parseInt(a[0]));
        if (!layers.length) {
            cont.innerHTML = `<div class="empty-state">
                <div class="empty-state__icon">◎</div>
                <div class="empty-state__title">No layers yet</div>
            </div>`;
            return;
        }
        cont.innerHTML = `<table class="data-table">
            <thead><tr><th>Layer</th><th>Nodes</th><th>Classes</th></tr></thead>
            <tbody>${layers.map(([w, d]) => `<tr>
                <td style="color:var(--accent-gold)">W${w}</td>
                <td>${d.count}</td>
                <td>${[...d.classes].map(c => c.toUpperCase()).join(', ')}</td>
            </tr>`).join('')}</tbody>
        </table>`;
    } else if (activeDataTab === 'config') {
        cont.innerHTML = `<div style="padding:12px;">
            <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Epoch</div>
            <div style="font-family:var(--font-mono);font-size:13px;color:${S.epochSet ? 'var(--accent-teal)' : 'var(--text-disabled)'}">
                ${S.epochSet ? S.epoch : 'Waiting for first data sample'}
            </div>
            <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 8px;">Cycle Duration</div>
            <div style="font-family:var(--font-mono);font-size:13px;color:var(--accent-gold)">${S.cycleHours}h</div>
            <div style="font-size:10px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 8px;">Asset Classes</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;">
                ${classes.map(c => `<span style="padding:4px 8px;background:rgba(70,180,175,0.1);border-radius:4px;font-size:10px;color:var(--accent-teal);font-weight:600">${c.symbol}</span>`).join('')}
            </div>
        </div>`;
    }
}

function formatTimestamp(ts) {
    if (!ts) return '—';
    const d = new Date(ts);
    return d.toLocaleString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
}

// ════════════════════════════════════════════════════════
// TORUS RENDER
// ════════════════════════════════════════════════════════
function render() {
    const w = cvs.width, h = cvs.height;
    if (w < 10 || h < 10) return;
    const cx = w/2, cy = h/2;
    
    ctx.fillStyle = '#0d0d1a';
    ctx.fillRect(0, 0, w, h);
    
    const maxW = Math.max(1, S.w || 1);
    const unit = Math.min(w, h) / (maxW * 3 + 2);
    
    // Draw layers
    for (let layer = 1; layer <= maxW; layer++) {
        const r = layer * unit * 1.2;
        if (r < 5) continue;
        
        const isActive = layer === S.w;
        const alpha = isActive ? 0.8 : 0.2;
        
        // Ring
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(212,175,55,${alpha})`;
        ctx.lineWidth = isActive ? 2 : 1;
        ctx.stroke();
        
        // Label
        if (r > 20) {
            ctx.fillStyle = `rgba(212,175,55,${alpha * 0.8})`;
            ctx.font = '600 9px Inter';
            ctx.textAlign = 'left';
            ctx.fillText('W' + layer, cx + r + 4, cy - 2);
        }
    }
    
    // Section lines
    ctx.strokeStyle = 'rgba(212,175,55,0.06)';
    ctx.lineWidth = 0.5;
    const outerR = maxW * unit * 1.2 + 20;
    for (let i = 0; i < 9; i++) {
        const deg = i * 40;
        const rad = (deg - 90) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(cx + Math.cos(rad) * unit * 0.5, cy + Math.sin(rad) * unit * 0.5);
        ctx.lineTo(cx + Math.cos(rad) * outerR, cy + Math.sin(rad) * outerR);
        ctx.stroke();
    }
    
    // Draw nodes
    nodes.forEach(n => {
        const r = (n.w_layer || 1) * unit * 1.2;
        const rad = ((n.theta || 0) - 90) * Math.PI / 180;
        const x = cx + Math.cos(rad) * r;
        const y = cy + Math.sin(rad) * r;
        
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fillStyle = n.node_type === 'data' ? 'rgba(70,180,175,0.7)' : 'rgba(173,235,179,0.7)';
        ctx.fill();
    });
    
    // Gold position marker
    if (S.w > 0 && S.epochSet) {
        const r = S.w * unit * 1.2;
        const rad = (S.theta - 90) * Math.PI / 180;
        const x = cx + Math.cos(rad) * r;
        const y = cy + Math.sin(rad) * r;
        
        // Glow
        const glow = ctx.createRadialGradient(x, y, 0, x, y, 16);
        glow.addColorStop(0, 'rgba(255,215,0,0.8)');
        glow.addColorStop(0.5, 'rgba(255,215,0,0.2)');
        glow.addColorStop(1, 'rgba(255,215,0,0)');
        ctx.fillStyle = glow;
        ctx.beginPath();
        ctx.arc(x, y, 16, 0, Math.PI * 2);
        ctx.fill();
        
        // Dot
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fillStyle = '#ffd700';
        ctx.fill();
        ctx.strokeStyle = '#b8860b';
        ctx.lineWidth = 1.5;
        ctx.stroke();
    }
}

// ════════════════════════════════════════════════════════
// SOCKET - STATE UPDATES
// ════════════════════════════════════════════════════════
socket.on('state', data => {
    document.getElementById('clock').textContent = data.time;
    document.getElementById('date').textContent = data.date;
    
    S.w = data.w;
    S.theta = data.theta;
    S.progress = data.progress;
    S.epoch = data.epoch;
    S.epochSet = data.epoch_set;
    S.cycleHours = data.cycle_hours;
    S.nodeCount = data.node_count;
    
    // Update HUD
    const dot = document.getElementById('epochDot');
    const label = document.getElementById('epochLabel');
    if (S.epochSet) {
        dot.classList.add('live');
        label.textContent = 'W' + S.w + ' · ' + Math.floor(S.theta) + '°';
    } else {
        dot.classList.remove('live');
        label.textContent = 'Epoch: waiting for data';
    }
    
    // Stats in panel
    document.getElementById('statW').textContent = S.w > 0 ? 'W' + S.w : '—';
    document.getElementById('statTheta').textContent = S.w > 0 ? Math.floor(S.theta) + '°' : '—';
    document.getElementById('statProgress').textContent = S.w > 0 ? Math.floor(S.progress * 100) + '%' : '—';
    document.getElementById('statNodes').textContent = S.nodeCount;
    
    // Stats in bar
    document.getElementById('barW').textContent = S.w > 0 ? S.w : '—';
    document.getElementById('barTheta').textContent = S.w > 0 ? Math.floor(S.theta) + '°' : '—';
    document.getElementById('barNodes').textContent = S.nodeCount;
    
    render();
});

socket.on('node', n => {
    nodes.push(n);
    renderDataContent();
    render();
});

// ════════════════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════════════════
loadClasses().then(() => {
    loadInstances();
    loadNodes();
});
</script>
</body>
</html>
